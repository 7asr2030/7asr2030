<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø­ØµØ± - ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</title>
  <style>
    :root{
      --saudi-green:#007a3d;
      --accent:#ffd24a;
      --bg:#f7fbf9;
      --card:#ffffff;
      --muted:#6b7280;
      --radius:12px;
      --present:#d4f7d4;
      --absent:#f7d4d4;
      --sleep:#f7f1d4;
      --escape:#f7d4f1;
      --late:#d4e3f7;
    }
    body{
      margin:0;font-family:'Tahoma','Arial',sans-serif;background:linear-gradient(180deg,var(--bg),#eef7f1);color:#0b1720;padding:16px;
      display:flex;align-items:center;justify-content:center;min-height:100vh;box-sizing:border-box;
    }
    .card{background:var(--card);border-radius:var(--radius);box-shadow:0 6px 18px rgba(3,22,9,0.06);padding:24px;max-width:420px;width:100%;text-align:center}
    h1{margin:0 0 16px;font-size:22px;color:var(--saudi-green)}
    .social-btn{display:flex;align-items:center;justify-content:center;gap:8px;width:100%;padding:12px;border-radius:10px;border:none;font-weight:700;font-size:15px;cursor:pointer;margin-bottom:10px}
    .google{background:#fff;border:1px solid #ddd;color:#000}
    .microsoft{background:#2f2f2f;color:#fff}
    .twitter{background:#1da1f2;color:#fff}
    .skip{background:transparent;color:var(--saudi-green);border:2px solid var(--saudi-green)}

    /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ */
    .app-container{display:none;flex-direction:column;gap:16px;width:100%;max-width:900px;text-align:right}
    label{font-weight:bold;margin-bottom:6px;color:#0b1720;display:block}
    input,button,select{padding:10px;border-radius:8px;border:1px solid #ccc;font-size:14px;width:100%;box-sizing:border-box}
    .upload-box{border:2px dashed var(--saudi-green);padding:20px;text-align:center;border-radius:var(--radius);cursor:pointer}
    .hidden{display:none}
    .progress-container{margin-top:10px;display:none}
    progress{width:100%;height:20px}

    .setup-section{margin-top:20px;display:none;}
    .students-list{margin-top:20px;display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:12px}
    .student-item{background:#fff;padding:12px;border-radius:10px;box-shadow:0 4px 8px rgba(0,0,0,0.05);display:flex;flex-direction:column;align-items:flex-start;gap:8px;transition:background 0.3s}
    .student-item span{font-weight:bold;color:#0b1720}

    #barcodeReader {margin: 20px auto; width: 100%; max-width: 500px; position: relative; min-height: 300px; background: #f8f9fa; border: 2px solid var(--saudi-green); border-radius: 8px; display: flex; align-items: center; justify-content: center;}
    #barcodeReader video {width: 100%; height: auto; border-radius: 8px; display: block !important; max-width: 100%;}
    #barcodeReader canvas {width: 100%; height: auto; border-radius: 8px; display: block !important;}
    .camera-container {display: flex; flex-direction: column; align-items: center; width: 100%;}
    .scan-indicator {position: absolute; top: 10px; left: 10px; background: rgba(0, 123, 255, 0.8); color: white; padding: 5px 10px; border-radius: 4px; font-size: 12px; z-index: 20;}
    .scan-frame {position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 200px; height: 200px; border: 2px dashed #007bff; border-radius: 8px; z-index: 15; pointer-events: none;}
    .scan-line {position: absolute; top: 0; left: 0; width: 100%; height: 2px; background: #007bff; animation: scan 2s linear infinite;}
    @keyframes scan {0% {top: 0;} 100% {top: 100%;}}
    .barcode-overlay {position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; z-index: 10;}
    .barcode-frame {position: absolute; border: 3px solid #007bff; border-radius: 8px; background: rgba(0, 123, 255, 0.1); display: none; animation: pulse 1s infinite;}
    @keyframes pulse {0% {opacity: 0.5;} 50% {opacity: 1;} 100% {opacity: 0.5;}}
    .barcode-text {position: absolute; top: -30px; left: 50%; transform: translateX(-50%); background: #007bff; color: white; padding: 5px 10px; border-radius: 4px; font-size: 12px; white-space: nowrap;}
  </style>
</head>
<body>
  <div class="card login-card" id="loginCard">
    <h1>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h1>
    <button class="social-btn google">ğŸ”µ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± Google</button>
    <button class="social-btn microsoft">ğŸŸ¢ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± Microsoft</button>
    <button class="social-btn twitter">ğŸ¦ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± Twitter</button>
    <button class="social-btn skip" id="skipBtn">ØªØ®Ø·ÙŠ ÙˆØ­ÙØ¸ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ù…Ø­Ù„ÙŠØ§Ù‹</button>
  </div>

  <div class="app-container" id="appContainer">
    <h1>Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø­ØµØ± - ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ÙˆÙŠØ¨</h1>
    <div>
      <label for="schoolName">Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</label>
      <input type="text" id="schoolName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©" />
    </div>
    <div>
      <label for="teacherName">Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…</label>
      <input type="text" id="teacherName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…" />
    </div>
    <div>
      <label for="excelFile">Ø±ÙØ¹ Ù…Ù„Ù Excel Ù„Ù„Ø·Ù„Ø§Ø¨</label>
      <div class="upload-box" onclick="document.getElementById('excelFile').click()">
        Ø§Ù†Ù‚Ø± Ù‡Ù†Ø§ Ù„Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù
      </div>
      <input type="file" id="excelFile" class="hidden" accept=".xlsx,.xls" />
      <div class="progress-container" id="progressContainer">
        <progress id="uploadProgress" value="0" max="100"></progress>
        <span id="progressText">0%</span>
      </div>
    </div>
    <button id="continueBtn" style="background:var(--saudi-green);color:#fff;border:none">Ù…ØªØ§Ø¨Ø¹Ø©</button>

    <!-- Ù‚Ø³Ù… Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø­ØµØ© -->
    <div class="setup-section" id="setupSection">
      <h2>Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø­ØµØ©</h2>
      <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©</label>
      <input type="text" id="subjectName" placeholder="Ù…Ø«Ø§Ù„: Ø±ÙŠØ§Ø¶ÙŠØ§Øª" />
      <label>Ø±Ù‚Ù… Ø§Ù„Ø­ØµØ©</label>
      <select id="period">
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
        <option value="6">6</option>
        <option value="7">7</option>
        <option value="8">8</option>
      </select>
      <label>Ø§Ù„ØµÙ</label>
      <select id="grade"></select>
      <label>Ø§Ù„ÙØµÙ„</label>
      <select id="classroom"></select>
      <button id="showStudentsBtn" style="background:var(--saudi-green);color:#fff;border:none;margin-top:10px">Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø§Ø¨</button>
      <button id="barcodeBtn" style="background:var(--accent);color:#000;border:none;margin-top:10px">ğŸ“· Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</button>
      <button id="stopBarcodeBtn" style="background:#dc3545;color:#fff;border:none;margin-top:10px;display:none">â¹ï¸ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø§Ø³Ø­</button>
      <button id="retryCameraBtn" style="background:#17a2b8;color:#fff;border:none;margin-top:10px;display:none">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
      <button id="checkCameraBtn" style="background:#6c757d;color:#fff;border:none;margin-top:10px">ğŸ” ÙØ­Øµ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
      <button id="testCameraBtn" style="background:#28a745;color:#fff;border:none;margin-top:10px">ğŸ¥ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
      <button id="testBarcodeBtn" style="background:#ffc107;color:#000;border:none;margin-top:10px">ğŸ” Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</button>
      <select id="cameraSelect" class="hidden"></select>
      <div id="barcodeReader" class="hidden">
        <div class="scan-indicator" id="scanIndicator">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø³Ø­...</div>
        <div class="scan-frame" id="scanFrame">
          <div class="scan-line"></div>
        </div>
        <div class="barcode-overlay">
          <div class="barcode-frame" id="barcodeFrame"></div>
          <div class="barcode-text" id="barcodeText"></div>
        </div>
      </div>
      <div id="barcodeStatus" class="hidden" style="margin-top:10px;padding:10px;background:#e9ecef;border-radius:8px;text-align:center"></div>
    </div>

    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ -->
    <div class="students-list hidden" id="studentsList"></div>
  </div>

  <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <script>
    let studentData = [];
    let grades = new Set();
    let classrooms = new Set();
    let html5QrCode;

    // Ø²Ø± Ø§Ù„ØªØ®Ø·ÙŠ
    document.getElementById('skipBtn').addEventListener('click',()=>{
      localStorage.setItem('skipLogin','true');
      document.getElementById('loginCard').style.display='none';
      document.getElementById('appContainer').style.display='flex';
    });

    window.addEventListener('load',()=>{
      if(localStorage.getItem('skipLogin')==='true'){
        document.getElementById('loginCard').style.display='none';
        document.getElementById('appContainer').style.display='flex';
      }
    });

    const excelInput = document.getElementById('excelFile');
    const progressContainer = document.getElementById('progressContainer');
    const progressBar = document.getElementById('uploadProgress');
    const progressText = document.getElementById('progressText');

    excelInput.addEventListener('change', ()=>{
      if(excelInput.files.length > 0){
        progressContainer.style.display='block';
        let progress = 0;
        const interval = setInterval(()=>{
          if(progress < 90){
            progress += 10; progressBar.value = progress; progressText.textContent = progress + "%";
          }
        },200);
        const reader = new FileReader();
        reader.onload = (e)=>{
          try{
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type:'array'});
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            const json = XLSX.utils.sheet_to_json(worksheet, {defval:""});
            studentData = json;

            // Ø§Ø³ØªØ®Ø±Ø¬ Ø§Ù„ØµÙÙˆÙ ÙˆØ§Ù„ÙØµÙˆÙ„ Ù…Ù† Ø§Ù„Ù…Ù„Ù
            grades = new Set(json.map(r=>r["Ø§Ù„ØµÙ"]).filter(Boolean));
            classrooms = new Set(json.map(r=>r["Ø§Ù„ÙØµÙ„"]).filter(Boolean));

            fillDropdowns();

            localStorage.setItem("studentsData", JSON.stringify(studentData));
            progress = 100; progressBar.value = 100; progressText.textContent = 'ØªÙ… Ø§Ù„Ø±ÙØ¹';
          }catch(err){ console.error(err); }
          clearInterval(interval);
        };
        reader.readAsArrayBuffer(excelInput.files[0]);
      }
    });

    function fillDropdowns(){
      const gradeSelect = document.getElementById('grade');
      const classSelect = document.getElementById('classroom');
      gradeSelect.innerHTML = '';
      classSelect.innerHTML = '';
      grades.forEach(g=>{
        const opt = document.createElement('option');
        opt.textContent = g;
        gradeSelect.appendChild(opt);
      });
      classrooms.forEach(c=>{
        const opt = document.createElement('option');
        opt.textContent = c;
        classSelect.appendChild(opt);
      });
    }

    document.getElementById('continueBtn').addEventListener('click', ()=>{
      document.getElementById('setupSection').style.display='block';
    });

    document.getElementById('showStudentsBtn').addEventListener('click', ()=>{
      const listDiv = document.getElementById('studentsList');
      listDiv.innerHTML = '';
      if(studentData.length === 0){
        listDiv.innerHTML = '<p>Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø£ÙŠ Ø·Ù„Ø§Ø¨ Ø¨Ø¹Ø¯</p>';
      } else {
        const selectedGrade = document.getElementById('grade').value;
        const selectedClass = document.getElementById('classroom').value;
        const filtered = studentData.filter(r=>{
          return (!selectedGrade || r["Ø§Ù„ØµÙ"]===selectedGrade) && (!selectedClass || r["Ø§Ù„ÙØµÙ„"]===selectedClass);
        });

        if(filtered.length === 0){
          listDiv.innerHTML = '<p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ØµÙ/Ø§Ù„ÙØµÙ„</p>';
        } else {
          filtered.forEach(r=>{
            const name = r["Ø§Ù„Ø§Ø³Ù…"] || r[Object.keys(r)[0]];
            const div = document.createElement('div');
            div.className = 'student-item';
            
            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ ÙÙŠ Ø¹Ø¯Ø© Ø£Ø¹Ù…Ø¯Ø© Ù…Ø­ØªÙ…Ù„Ø©
            const studentId = r["Ø§Ù„Ù‡ÙˆÙŠØ©"] || r["Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨"] || r["Ø§Ù„Ø±Ù‚Ù…"] || r["ID"] || r["id"] || r["Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠ"] || r["Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ"] || name;
            div.setAttribute('data-id', studentId);
            
            // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ø¨Ø­Ø«
            div.setAttribute('data-name', name);
            div.setAttribute('data-all-ids', JSON.stringify([
              r["Ø§Ù„Ù‡ÙˆÙŠØ©"], r["Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨"], r["Ø§Ù„Ø±Ù‚Ù…"], r["ID"], r["id"], 
              r["Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠ"], r["Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ"], name
            ].filter(Boolean)));
            
            // Ø¥Ø¶Ø§ÙØ© QR code data Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
            if (r["Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯"] && typeof r["Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯"] === 'string') {
              div.setAttribute('data-qr-content', r["Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯"]);
            }
            const select = document.createElement('select');
            select.innerHTML = `
              <option value="">Ø§Ø®ØªØ±</option>
              <option value="Ø­Ø§Ø¶Ø±">Ø­Ø§Ø¶Ø±</option>
              <option value="ØºØ§Ø¦Ø¨">ØºØ§Ø¦Ø¨</option>
              <option value="Ù†Ø§Ø¦Ù…">Ù†Ø§Ø¦Ù…</option>
              <option value="Ù‡Ø§Ø±Ø¨">Ù‡Ø§Ø±Ø¨</option>
              <option value="Ù…ØªØ£Ø®Ø±">Ù…ØªØ£Ø®Ø±</option>
            `;
            select.addEventListener('change', ()=>{
              div.style.background = '';
              switch(select.value){
                case 'Ø­Ø§Ø¶Ø±': div.style.background = 'var(--present)'; break;
                case 'ØºØ§Ø¦Ø¨': div.style.background = 'var(--absent)'; break;
                case 'Ù†Ø§Ø¦Ù…': div.style.background = 'var(--sleep)'; break;
                case 'Ù‡Ø§Ø±Ø¨': div.style.background = 'var(--escape)'; break;
                case 'Ù…ØªØ£Ø®Ø±': div.style.background = 'var(--late)'; break;
                default: div.style.background = '#fff';
              }
            });
            div.appendChild(document.createElement('span')).textContent = name;
            div.appendChild(select);
            listDiv.appendChild(div);
          });
        }
      }
      listDiv.classList.remove('hidden');
    });

    // ====== Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ======
    document.getElementById('barcodeBtn').addEventListener('click', async ()=>{
      const readerDiv = document.getElementById('barcodeReader');
      const cameraSelect = document.getElementById('cameraSelect');
      const statusDiv = document.getElementById('barcodeStatus');
      const barcodeBtn = document.getElementById('barcodeBtn');
      const stopBtn = document.getElementById('stopBarcodeBtn');
      
      readerDiv.classList.remove('hidden');
      cameraSelect.classList.remove('hidden');
      statusDiv.classList.remove('hidden');
      readerDiv.innerHTML = '';
      statusDiv.innerHTML = 'Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§...';
      barcodeBtn.style.display = 'none';
      stopBtn.style.display = 'inline-block';

      // ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø³ÙŠØ§Ù‚ Ø§Ù„Ø¢Ù…Ù† (HTTPS Ø£Ùˆ localhost)
      const isSecure = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
      if(!isSecure){
        statusDiv.innerHTML = 'ÙŠØ¬Ø¨ ÙØªØ­ Ø§Ù„ØµÙØ­Ø© Ø¹Ø¨Ø± HTTPS Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§.';
        return;
      }

      // ØªØ­Ù‚Ù‚ Ù…Ù† Ø¯Ø¹Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        statusDiv.innerHTML = 'Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§. Ø¬Ø±Ø¨ Chrome Ø£Ùˆ Firefox.';
        return;
      }

      // Ø£ÙˆÙ‚Ù Ø£ÙŠ Ù…Ø§Ø³Ø­ ÙŠØ¹Ù…Ù„ Ø­Ø§Ù„ÙŠØ§Ù‹
      if(html5QrCode){
        try { await html5QrCode.stop(); } catch(_) {}
      }

      // Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø³Ø­ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø¯ÙˆÙ† ØªØ¹Ø¯Ø§Ø¯ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§Øª
      statusDiv.innerHTML = 'Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§...';
      
      // ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¸Ù‡Ø§Ø± Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
      readerDiv.style.display = 'flex';
      readerDiv.style.minHeight = '300px';
      readerDiv.style.border = '2px solid var(--saudi-green)';
      readerDiv.style.borderRadius = '8px';
      readerDiv.style.background = '#f8f9fa';
      readerDiv.style.alignItems = 'center';
      readerDiv.style.justifyContent = 'center';
      readerDiv.innerHTML = '<div style="text-align: center; color: #666;"><div style="font-size: 24px; margin-bottom: 10px;">ğŸ“·</div><div>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§...</div></div>';
      
      // Ø­Ø§ÙˆÙ„ Ø§Ù„Ø¨Ø¯Ø¡ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø®Ù„ÙÙŠØ©
      try{
        await startScanner(null);
      }catch(err){
        console.error('ÙØ´Ù„ Ø§Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±', err);
        statusDiv.innerHTML = 'ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§. ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ù†Ø­ Ø¥Ø°Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§.';
        
        // Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø¸Ù‡Ø§Ø± Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ…
        barcodeBtn.style.display = 'inline-block';
        stopBtn.style.display = 'none';
      }
    });

    // Ø²Ø± Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø§Ø³Ø­
    document.getElementById('stopBarcodeBtn').addEventListener('click', async ()=>{
      const readerDiv = document.getElementById('barcodeReader');
      const cameraSelect = document.getElementById('cameraSelect');
      const statusDiv = document.getElementById('barcodeStatus');
      const barcodeBtn = document.getElementById('barcodeBtn');
      const stopBtn = document.getElementById('stopBarcodeBtn');
      const retryBtn = document.getElementById('retryCameraBtn');
      
      // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
      if (window.stopScanning) {
        window.stopScanning();
      }
      
      // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ…
      if(html5QrCode){
        try { 
          await html5QrCode.stop(); 
          html5QrCode = null;
        } catch(_) {}
      }
      
      readerDiv.classList.add('hidden');
      cameraSelect.classList.add('hidden');
      statusDiv.classList.add('hidden');
      barcodeBtn.style.display = 'inline-block';
      stopBtn.style.display = 'none';
      retryBtn.style.display = 'none';
      statusDiv.innerHTML = '';
    });

    // Ø²Ø± Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
    document.getElementById('retryCameraBtn').addEventListener('click', async ()=>{
      const retryBtn = document.getElementById('retryCameraBtn');
      retryBtn.style.display = 'none';
      
      // Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø§Ø³Ø­
      document.getElementById('barcodeBtn').click();
    });

    // Ø²Ø± ÙØ­Øµ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
    document.getElementById('checkCameraBtn').addEventListener('click', async ()=>{
      const statusDiv = document.getElementById('barcodeStatus');
      statusDiv.classList.remove('hidden');
      statusDiv.innerHTML = 'Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§...';
      
      try {
        // ÙØ­Øµ Ø¯Ø¹Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          statusDiv.innerHTML = 'âŒ Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§. Ø¬Ø±Ø¨ Chrome Ø£Ùˆ Firefox.';
          return;
        }

        // ÙØ­Øµ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoDevices = devices.filter(device => device.kind === 'videoinput');
        
        if (videoDevices.length === 0) {
          statusDiv.innerHTML = 'âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙƒØ§Ù…ÙŠØ±Ø§Øª Ù…ØªØ§Ø­Ø©.';
          return;
        }

        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        stream.getTracks().forEach(track => track.stop());
        
        statusDiv.innerHTML = `
          <div style="color: #28a745;">
            âœ… <strong>Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØªØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­!</strong><br>
            â€¢ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${videoDevices.length} ÙƒØ§Ù…ÙŠØ±Ø§<br>
            â€¢ ØªÙ… Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­<br>
            â€¢ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø§Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
          </div>
        `;
        
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§:', error);
        statusDiv.innerHTML = `
          <div style="color: #dc3545;">
            âŒ <strong>Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§:</strong><br>
            ${error.message}<br><br>
            <strong>Ø§Ù„Ø­Ù„ÙˆÙ„:</strong><br>
            â€¢ ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ù†Ø­ Ø¥Ø°Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§<br>
            â€¢ Ø£ØºÙ„Ù‚ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰<br>
            â€¢ Ø¬Ø±Ø¨ Ù…ØªØµÙØ­ Ø¢Ø®Ø±
          </div>
        `;
      }
    });

    // Ø²Ø± Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
    document.getElementById('testCameraBtn').addEventListener('click', async ()=>{
      const readerDiv = document.getElementById('barcodeReader');
      const statusDiv = document.getElementById('barcodeStatus');
      
      readerDiv.classList.remove('hidden');
      statusDiv.classList.remove('hidden');
      statusDiv.innerHTML = 'Ø¬Ø§Ø±ÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§...';
      
      // ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¸Ù‡Ø§Ø± Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
      readerDiv.style.display = 'flex';
      readerDiv.style.minHeight = '300px';
      readerDiv.style.border = '2px solid var(--saudi-green)';
      readerDiv.style.borderRadius = '8px';
      readerDiv.style.background = '#f8f9fa';
      readerDiv.style.alignItems = 'center';
      readerDiv.style.justifyContent = 'center';
      readerDiv.innerHTML = '<div style="text-align: center; color: #666;"><div style="font-size: 24px; margin-bottom: 10px;">ğŸ“·</div><div>Ø¬Ø§Ø±ÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§...</div></div>';
      
      try {
        // Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø¨Ø§Ø´Ø± Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§
        const stream = await navigator.mediaDevices.getUserMedia({ 
          video: { 
            facingMode: { ideal: 'environment' },
            width: { ideal: 640 },
            height: { ideal: 480 }
          } 
        });
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± ÙÙŠØ¯ÙŠÙˆ Ù…Ø¨Ø§Ø´Ø±
        const video = document.createElement('video');
        video.srcObject = stream;
        video.autoplay = true;
        video.playsInline = true;
        video.style.width = '100%';
        video.style.height = 'auto';
        video.style.borderRadius = '8px';
        
        readerDiv.innerHTML = '';
        readerDiv.appendChild(video);
        
        statusDiv.innerHTML = `
          <div style="color: #28a745;">
            âœ… <strong>Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØªØ¹Ù…Ù„ Ø¨Ù†Ø¬Ø§Ø­!</strong><br>
            ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø§Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
          </div>
        `;
        
        // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨Ø« Ø¨Ø¹Ø¯ 10 Ø«ÙˆØ§Ù†
        setTimeout(() => {
          stream.getTracks().forEach(track => track.stop());
          readerDiv.innerHTML = '<div style="text-align: center; color: #666;"><div style="font-size: 24px; margin-bottom: 10px;">ğŸ“·</div><div>Ø§Ù†ØªÙ‡Ù‰ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</div></div>';
        }, 10000);
        
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§:', error);
        statusDiv.innerHTML = `
          <div style="color: #dc3545;">
            âŒ <strong>ÙØ´Ù„ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§:</strong><br>
            ${error.message}<br><br>
            <strong>Ø§Ù„Ø­Ù„ÙˆÙ„:</strong><br>
            â€¢ ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ù†Ø­ Ø¥Ø°Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§<br>
            â€¢ Ø£ØºÙ„Ù‚ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰<br>
            â€¢ Ø¬Ø±Ø¨ Ù…ØªØµÙØ­ Ø¢Ø®Ø±
          </div>
        `;
        readerDiv.innerHTML = '<div style="text-align: center; color: #dc3545;"><div style="font-size: 24px; margin-bottom: 10px;">âŒ</div><div>ÙØ´Ù„ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</div></div>';
      }
    });

    // Ø²Ø± Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
    document.getElementById('testBarcodeBtn').addEventListener('click', ()=>{
      const testBarcode = prompt('Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø£Ùˆ Ù…Ø­ØªÙˆÙ‰ QR Code Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±:');
      if (testBarcode) {
        console.log('Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯:', testBarcode);
        handleBarcodeScanned(testBarcode);
      }
    });

    async function startScanner(cameraId){
      const readerDiv = document.getElementById('barcodeReader');
      const statusDiv = document.getElementById('barcodeStatus');
      
      try {
        statusDiv.innerHTML = 'Ø¬Ø§Ø±ÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§...';
        
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†ÙØ³ Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªÙŠ ØªØ¹Ù…Ù„ Ù…Ø¹ Ø²Ø± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
        const stream = await navigator.mediaDevices.getUserMedia({ 
          video: { 
            facingMode: { ideal: 'environment' },
            width: { ideal: 640 },
            height: { ideal: 480 }
          } 
        });
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± ÙÙŠØ¯ÙŠÙˆ Ù…Ø¨Ø§Ø´Ø±
        const video = document.createElement('video');
        video.srcObject = stream;
        video.autoplay = true;
        video.playsInline = true;
        video.style.width = '100%';
        video.style.height = 'auto';
        video.style.borderRadius = '8px';
        video.id = 'cameraVideo';
        
        readerDiv.innerHTML = '';
        readerDiv.appendChild(video);
        
        statusDiv.innerHTML = 'Ø§Ù„Ù…Ø§Ø³Ø­ ÙŠØ¹Ù…Ù„ - ÙˆØ¬Ù‡ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§';
        
        // Ø¨Ø¯Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ÙƒØªØ¨Ø© QuaggaJS Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Html5Qrcode
        startBarcodeDetection(video, stream);
        
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§:', error);
        statusDiv.innerHTML = `
          <div style="color: #dc3545;">
            âŒ <strong>ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§:</strong><br>
            ${error.message}<br><br>
            <strong>Ø§Ù„Ø­Ù„ÙˆÙ„:</strong><br>
            â€¢ ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ù†Ø­ Ø¥Ø°Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§<br>
            â€¢ Ø£ØºÙ„Ù‚ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰<br>
            â€¢ Ø¬Ø±Ø¨ Ù…ØªØµÙØ­ Ø¢Ø®Ø±
          </div>
        `;
        
        // Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø¸Ù‡Ø§Ø± Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ…
        const barcodeBtn = document.getElementById('barcodeBtn');
        const stopBtn = document.getElementById('stopBarcodeBtn');
        const retryBtn = document.getElementById('retryCameraBtn');
        barcodeBtn.style.display = 'inline-block';
        stopBtn.style.display = 'none';
        retryBtn.style.display = 'inline-block';
      }
    }

    // Ø¯Ø§Ù„Ø© Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… QuaggaJS
    function startBarcodeDetection(video, stream) {
      const statusDiv = document.getElementById('barcodeStatus');
      let isScanning = true;
      
      // Ø¥Ù†Ø´Ø§Ø¡ canvas Ù„Ø±Ø³Ù… Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¹Ù„ÙŠÙ‡
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      canvas.style.display = 'none';
      document.body.appendChild(canvas);
      
      // Ø¯Ø§Ù„Ø© Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
      function scanFrame() {
        if (!isScanning) return;
        
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        // ØªØ­Ø³ÙŠÙ† Ø¬ÙˆØ¯Ø© Ø§Ù„ØµÙˆØ±Ø© Ù„Ù„Ù‚Ø±Ø§Ø¡Ø©
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… jsQR Ù„Ù‚Ø±Ø§Ø¡Ø© QR codes Ù…Ø¹ ØªØ­Ø³ÙŠÙ†Ø§Øª
        const code = jsQR(imageData.data, imageData.width, imageData.height, {
          inversionAttempts: "dontInvert"
        });
        
        if (code) {
          console.log('ØªÙ… Ù‚Ø±Ø§Ø¡Ø© QR Code:', code.data);
          console.log('Ù…ÙˆÙ‚Ø¹ QR Code:', code.location);
          handleBarcodeScanned(code.data);
          isScanning = false;
          return;
        }
        
        // Ø¥Ø°Ø§ Ù„Ù… ÙŠØ¬Ø¯ QR codeØŒ Ø¬Ø±Ø¨ QuaggaJS Ù„Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ø¹Ø§Ø¯ÙŠ
        Quagga.decodeSingle({
          src: canvas.toDataURL(),
          numOfWorkers: 0,
          inputStream: {
            size: 800
          },
          decoder: {
            readers: ['code_128_reader', 'ean_reader', 'ean_8_reader', 'code_39_reader', 'code_39_vin_reader', 'codabar_reader', 'upc_reader', 'upc_e_reader', 'i2of5_reader']
          }
        }, function(result) {
          if (result && result.codeResult) {
            console.log('ØªÙ… Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯:', result.codeResult.code);
            handleBarcodeScanned(result.codeResult.code);
            isScanning = false;
            return;
          }
        });
        
        // Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø± ÙÙŠ Ø§Ù„Ù…Ø³Ø­
        if (isScanning) {
          requestAnimationFrame(scanFrame);
        }
      }
      
      // Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø³Ø­
      video.addEventListener('loadedmetadata', () => {
        scanFrame();
      });
      
      // Ø­ÙØ¸ Ø§Ù„Ù…Ø±Ø¬Ø¹ Ù„Ù„Ø¥ÙŠÙ‚Ø§Ù Ù„Ø§Ø­Ù‚Ø§Ù‹
      window.currentStream = stream;
      window.currentVideo = video;
      window.currentCanvas = canvas;
      window.isScanning = () => isScanning;
      window.stopScanning = () => {
        isScanning = false;
        if (stream) {
          stream.getTracks().forEach(track => track.stop());
        }
        if (canvas && canvas.parentNode) {
          canvas.parentNode.removeChild(canvas);
        }
      };
    }

    // Ø¯Ø§Ù„Ø© Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡
    function handleBarcodeScanned(decodedText) {
      const statusDiv = document.getElementById('barcodeStatus');
      
      console.log('Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯:', decodedText);
      
      // Ø¥Ø¸Ù‡Ø§Ø± Ø¥Ø·Ø§Ø± Ø£Ø²Ø±Ù‚ Ø­ÙˆÙ„ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ (Ù…Ø¤Ù‚Øª)
      showBarcodeFrame({ decodedText });
      
      const listDiv = document.getElementById('studentsList');
      const items = listDiv.querySelectorAll('.student-item');
      let found = false;
      let studentName = '';
      let matchedId = '';
      
      // ØªÙ†Ø¸ÙŠÙ Ù†Øµ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
      const cleanBarcode = decodedText.toString().trim();
      
      items.forEach(item=>{
        const studentId = item.getAttribute('data-id');
        const studentName = item.getAttribute('data-name');
        const allIds = JSON.parse(item.getAttribute('data-all-ids') || '[]');
        const qrContent = item.getAttribute('data-qr-content');
        
        // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø©
        const searchIds = [studentId, ...allIds].filter(Boolean);
        
        // Ø¥Ø¶Ø§ÙØ© Ù…Ø­ØªÙˆÙ‰ QR code Ù„Ù„Ø¨Ø­Ø«
        if (qrContent) {
          searchIds.push(qrContent);
        }
        
        for(let id of searchIds) {
          const cleanId = id.toString().trim();
          
          // Ù…Ù‚Ø§Ø±Ù†Ø© Ø¯Ù‚ÙŠÙ‚Ø©
          if (cleanBarcode === cleanId || 
              cleanBarcode.includes(cleanId) || 
              cleanId.includes(cleanBarcode)) {
            
            const select = item.querySelector('select');
            select.value = 'Ø­Ø§Ø¶Ø±';
            item.style.background = 'var(--present)';
            found = true;
            matchedId = cleanId;
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ ÙÙ‚Ø· Ø¨Ø¯ÙˆÙ† Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
            statusDiv.innerHTML = `<div style="color: #28a745; font-weight: bold; text-align: center;">${studentName}</div>`;
            
            // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ± Ø¨ØµØ±ÙŠ Ø³Ø±ÙŠØ¹
            item.style.transform = 'scale(1.05)';
            setTimeout(() => {
              item.style.transform = 'scale(1)';
            }, 300);
            
            console.log('ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø·Ø§Ø¨Ù‚Ø©:', { studentName, matchedId, barcode: cleanBarcode });
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø³Ø­ Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØªÙŠÙ†
            setTimeout(() => {
              if (window.isScanning && window.isScanning()) {
                // Ø§Ù„Ù…Ø³Ø­ ÙŠØ¹Ù…Ù„ØŒ Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„
                return;
              }
              // Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø³Ø­
              const video = document.getElementById('cameraVideo');
              if (video && video.srcObject) {
                startBarcodeDetection(video, video.srcObject);
              }
            }, 2000);
            
            return; // ØªÙˆÙ‚Ù Ø¹Ù†Ø¯ Ø£ÙˆÙ„ Ù…Ø·Ø§Ø¨Ù‚Ø©
          }
        }
      });
      
      if(!found){
        statusDiv.innerHTML = `
          <div style="color: #dc3545;">
            âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø·Ø§Ù„Ø¨ Ø¨Ø§Ù„Ø±Ù‚Ù…: ${cleanBarcode}<br>
            <small>ØªØ£ÙƒØ¯ Ù…Ù†:</small><br>
            â€¢ Ø±ÙØ¹ Ù…Ù„Ù Excel Ù„Ù„Ø·Ù„Ø§Ø¨<br>
            â€¢ Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨<br>
            â€¢ Ø£Ù† Ù…Ø­ØªÙˆÙ‰ QR Code Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø¹Ù…ÙˆØ¯ "Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯"<br>
            â€¢ Ø£Ùˆ Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙˆØ¯ "Ø§Ù„Ù‡ÙˆÙŠØ©" ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø±Ù‚Ø§Ù… ÙØ±ÙŠØ¯Ø©
          </div>
        `;
        console.log('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯:', cleanBarcode);
        console.log('Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…ØªØ§Ø­ÙŠÙ†:', Array.from(items).map(item => ({
          name: item.getAttribute('data-name'),
          id: item.getAttribute('data-id'),
          allIds: item.getAttribute('data-all-ids')
        })));
      }
    }

    // Ø¯Ø§Ù„Ø© Ø¥Ø¸Ù‡Ø§Ø± Ø¥Ø·Ø§Ø± Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
    function showBarcodeFrame(decodedResult) {
      const frame = document.getElementById('barcodeFrame');
      const text = document.getElementById('barcodeText');
      const scanFrame = document.getElementById('scanFrame');
      const scanIndicator = document.getElementById('scanIndicator');
      
      // Ø¥Ø®ÙØ§Ø¡ Ø¥Ø·Ø§Ø± Ø§Ù„Ù…Ø³Ø­
      if (scanFrame) scanFrame.style.display = 'none';
      if (scanIndicator) scanIndicator.style.display = 'none';
      
      // Ø¥Ø¸Ù‡Ø§Ø± Ø¥Ø·Ø§Ø± ÙÙŠ Ù…Ù†ØªØµÙ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
      const readerDiv = document.getElementById('barcodeReader');
      const rect = readerDiv.getBoundingClientRect();
      
      // Ø¥Ø·Ø§Ø± ÙÙŠ Ù…Ù†ØªØµÙ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©
      frame.style.left = '50%';
      frame.style.top = '50%';
      frame.style.width = '200px';
      frame.style.height = '100px';
      frame.style.transform = 'translate(-50%, -50%)';
      frame.style.display = 'block';
      frame.style.border = '3px solid #28a745';
      frame.style.background = 'rgba(40, 167, 69, 0.1)';
      frame.style.borderRadius = '8px';
      frame.style.animation = 'pulse 1s infinite';
      
      // Ø¥Ø¸Ù‡Ø§Ø± Ù†Øµ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
      text.style.left = '50%';
      text.style.top = '20px';
      text.style.transform = 'translateX(-50%)';
      text.textContent = decodedResult.decodedText || 'ØªÙ… Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯';
      text.style.display = 'block';
      text.style.background = '#28a745';
      text.style.color = 'white';
      text.style.padding = '5px 10px';
      text.style.borderRadius = '4px';
      text.style.fontSize = '12px';
      
      // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¥Ø·Ø§Ø± Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØ© ÙˆØ§Ø­Ø¯Ø©
      setTimeout(() => {
        frame.style.display = 'none';
        text.style.display = 'none';
        // Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø¸Ù‡Ø§Ø± Ø¥Ø·Ø§Ø± Ø§Ù„Ù…Ø³Ø­
        if (scanFrame) scanFrame.style.display = 'block';
        if (scanIndicator) scanIndicator.style.display = 'block';
      }, 1000);
    }
  </script>
</body>
</html>