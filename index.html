<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>مساعد الحصر - تسجيل الدخول</title>
  <style>
    :root{
      --saudi-green:#007a3d;
      --accent:#ffd24a;
      --bg:#f7fbf9;
      --card:#ffffff;
      --muted:#6b7280;
      --radius:12px;
      --present:#d4f7d4;
      --absent:#f7d4d4;
      --sleep:#f7f1d4;
      --escape:#f7d4f1;
      --late:#d4e3f7;
    }
    body{
      margin:0;font-family:'Tahoma','Arial',sans-serif;background:linear-gradient(180deg,var(--bg),#eef7f1);color:#0b1720;padding:16px;
      display:flex;align-items:center;justify-content:center;min-height:100vh;box-sizing:border-box;
    }
    .card{background:var(--card);border-radius:var(--radius);box-shadow:0 6px 18px rgba(3,22,9,0.06);padding:24px;max-width:420px;width:100%;text-align:center}
    h1{margin:0 0 16px;font-size:22px;color:var(--saudi-green)}
    .social-btn{display:flex;align-items:center;justify-content:center;gap:8px;width:100%;padding:12px;border-radius:10px;border:none;font-weight:700;font-size:15px;cursor:pointer;margin-bottom:10px}
    .google{background:#fff;border:1px solid #ddd;color:#000}
    .microsoft{background:#2f2f2f;color:#fff}
    .twitter{background:#1da1f2;color:#fff}
    .skip{background:transparent;color:var(--saudi-green);border:2px solid var(--saudi-green)}

    /* تنسيقات واجهة التطبيق */
    .app-container{display:none;flex-direction:column;gap:16px;width:100%;max-width:900px;text-align:right}
    label{font-weight:bold;margin-bottom:6px;color:#0b1720;display:block}
    input,button,select{padding:10px;border-radius:8px;border:1px solid #ccc;font-size:14px;width:100%;box-sizing:border-box}
    .upload-box{border:2px dashed var(--saudi-green);padding:20px;text-align:center;border-radius:var(--radius);cursor:pointer}
    .hidden{display:none}
    .progress-container{margin-top:10px;display:none}
    progress{width:100%;height:20px}

    .setup-section{margin-top:20px;display:none;}
    .students-list{margin-top:20px;display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:12px}
    .student-item{background:#fff;padding:12px;border-radius:10px;box-shadow:0 4px 8px rgba(0,0,0,0.05);display:flex;flex-direction:column;align-items:flex-start;gap:8px;transition:background 0.3s}
    .student-item span{font-weight:bold;color:#0b1720}

    #barcodeReader {margin: 20px auto; width: 100%; max-width: 500px; position: relative; min-height: 300px;}
  </style>
</head>
<body>
  <div class="card login-card" id="loginCard">
    <h1>تسجيل الدخول</h1>
    <button class="social-btn google">🔵 تسجيل الدخول عبر Google</button>
    <button class="social-btn microsoft">🟢 تسجيل الدخول عبر Microsoft</button>
    <button class="social-btn twitter">🐦 تسجيل الدخول عبر Twitter</button>
    <button class="social-btn skip" id="skipBtn">تخطي وحفظ الأعمال محلياً</button>
  </div>

  <div class="app-container" id="appContainer">
    <h1>مساعد الحصر - واجهة الويب</h1>
    <div>
      <label for="schoolName">اسم المدرسة</label>
      <input type="text" id="schoolName" placeholder="أدخل اسم المدرسة" />
    </div>
    <div>
      <label for="teacherName">اسم المعلم</label>
      <input type="text" id="teacherName" placeholder="أدخل اسم المعلم" />
    </div>
    <div>
      <label for="excelFile">رفع ملف Excel للطلاب</label>
      <div class="upload-box" onclick="document.getElementById('excelFile').click()">
        انقر هنا لرفع الملف
      </div>
      <input type="file" id="excelFile" class="hidden" accept=".xlsx,.xls" />
      <div class="progress-container" id="progressContainer">
        <progress id="uploadProgress" value="0" max="100"></progress>
        <span id="progressText">0%</span>
      </div>
    </div>
    <button id="continueBtn" style="background:var(--saudi-green);color:#fff;border:none">متابعة</button>

    <!-- قسم إعداد الحصة -->
    <div class="setup-section" id="setupSection">
      <h2>إعداد الحصة</h2>
      <label>اسم المادة</label>
      <input type="text" id="subjectName" placeholder="مثال: رياضيات" />
      <label>رقم الحصة</label>
      <select id="period">
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
        <option value="6">6</option>
        <option value="7">7</option>
        <option value="8">8</option>
      </select>
      <label>الصف</label>
      <select id="grade"></select>
      <label>الفصل</label>
      <select id="classroom"></select>
      <button id="showStudentsBtn" style="background:var(--saudi-green);color:#fff;border:none;margin-top:10px">عرض الطلاب</button>
      <button id="barcodeBtn" style="background:var(--accent);color:#000;border:none;margin-top:10px">📷 قراءة الباركود</button>
      <button id="stopBarcodeBtn" style="background:#dc3545;color:#fff;border:none;margin-top:10px;display:none">⏹️ إيقاف الماسح</button>
      <button id="exportExcelBtn" style="background:#28a745;color:#fff;border:none;margin-top:10px">📊 تصدير Excel</button>
      <button id="exportPdfBtn" style="background:#dc3545;color:#fff;border:none;margin-top:10px">📄 تصدير PDF</button>
      <select id="cameraSelect" class="hidden"></select>
      <div id="barcodeReader" class="hidden"></div>
      <div id="barcodeStatus" class="hidden" style="margin-top:10px;padding:10px;background:#e9ecef;border-radius:8px;text-align:center"></div>
    </div>

    <!-- قائمة الطلاب -->
    <div class="students-list hidden" id="studentsList"></div>
  </div>

  <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    let studentData = [];
    let grades = new Set();
    let classrooms = new Set();
    let html5QrCode;

    // زر التخطي
    document.getElementById('skipBtn').addEventListener('click',()=>{
      localStorage.setItem('skipLogin','true');
      document.getElementById('loginCard').style.display='none';
      document.getElementById('appContainer').style.display='flex';
    });

    window.addEventListener('load',()=>{
      if(localStorage.getItem('skipLogin')==='true'){
        document.getElementById('loginCard').style.display='none';
        document.getElementById('appContainer').style.display='flex';
      }
    });

    const excelInput = document.getElementById('excelFile');
    const progressContainer = document.getElementById('progressContainer');
    const progressBar = document.getElementById('uploadProgress');
    const progressText = document.getElementById('progressText');

    excelInput.addEventListener('change', ()=>{
      if(excelInput.files.length > 0){
        progressContainer.style.display='block';
        let progress = 0;
        const interval = setInterval(()=>{
          if(progress < 90){
            progress += 10; progressBar.value = progress; progressText.textContent = progress + "%";
          }
        },200);
        const reader = new FileReader();
        reader.onload = (e)=>{
          try{
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type:'array'});
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            const json = XLSX.utils.sheet_to_json(worksheet, {defval:""});
            studentData = json;

            // استخرج الصفوف والفصول من الملف
            grades = new Set(json.map(r=>r["الصف"]).filter(Boolean));
            classrooms = new Set(json.map(r=>r["الفصل"]).filter(Boolean));

            fillDropdowns();

            localStorage.setItem("studentsData", JSON.stringify(studentData));
            progress = 100; progressBar.value = 100; progressText.textContent = 'تم الرفع';
          }catch(err){ console.error(err); }
          clearInterval(interval);
        };
        reader.readAsArrayBuffer(excelInput.files[0]);
      }
    });

    function fillDropdowns(){
      const gradeSelect = document.getElementById('grade');
      const classSelect = document.getElementById('classroom');
      gradeSelect.innerHTML = '';
      classSelect.innerHTML = '';
      grades.forEach(g=>{
        const opt = document.createElement('option');
        opt.textContent = g;
        gradeSelect.appendChild(opt);
      });
      classrooms.forEach(c=>{
        const opt = document.createElement('option');
        opt.textContent = c;
        classSelect.appendChild(opt);
      });
    }

    document.getElementById('continueBtn').addEventListener('click', ()=>{
      document.getElementById('setupSection').style.display='block';
    });

    document.getElementById('showStudentsBtn').addEventListener('click', ()=>{
      const listDiv = document.getElementById('studentsList');
      listDiv.innerHTML = '';
      if(studentData.length === 0){
        listDiv.innerHTML = '<p>لم يتم تحميل أي طلاب بعد</p>';
      } else {
        const selectedGrade = document.getElementById('grade').value;
        const selectedClass = document.getElementById('classroom').value;
        const filtered = studentData.filter(r=>{
          return (!selectedGrade || r["الصف"]===selectedGrade) && (!selectedClass || r["الفصل"]===selectedClass);
        });

        if(filtered.length === 0){
          listDiv.innerHTML = '<p>لا يوجد طلاب في هذا الصف/الفصل</p>';
        } else {
          filtered.forEach(r=>{
            const name = r["الاسم"] || r[Object.keys(r)[0]];
            const div = document.createElement('div');
            div.className = 'student-item';
            
            // البحث عن رقم الطالب في عدة أعمدة محتملة
            const studentId = r["الهوية"] || r["رقم الطالب"] || r["الرقم"] || r["ID"] || r["id"] || r["الرقم الأكاديمي"] || r["الرقم الدراسي"] || name;
            div.setAttribute('data-id', studentId);
            
            // إضافة معلومات إضافية للبحث
            div.setAttribute('data-name', name);
            div.setAttribute('data-all-ids', JSON.stringify([
              r["الهوية"], r["رقم الطالب"], r["الرقم"], r["ID"], r["id"], 
              r["الرقم الأكاديمي"], r["الرقم الدراسي"], name
            ].filter(Boolean)));
            
            // إضافة QR code data إذا كان موجوداً
            if (r["الباركود"] && typeof r["الباركود"] === 'string') {
              div.setAttribute('data-qr-content', r["الباركود"]);
            }
            const select = document.createElement('select');
            select.innerHTML = `
              <option value="">اختر</option>
              <option value="حاضر">حاضر</option>
              <option value="غائب">غائب</option>
              <option value="نائم">نائم</option>
              <option value="هارب">هارب</option>
              <option value="متأخر">متأخر</option>
            `;
            select.addEventListener('change', ()=>{
              div.style.background = '';
              switch(select.value){
                case 'حاضر': div.style.background = 'var(--present)'; break;
                case 'غائب': div.style.background = 'var(--absent)'; break;
                case 'نائم': div.style.background = 'var(--sleep)'; break;
                case 'هارب': div.style.background = 'var(--escape)'; break;
                case 'متأخر': div.style.background = 'var(--late)'; break;
                default: div.style.background = '#fff';
              }
            });
            div.appendChild(document.createElement('span')).textContent = name;
            div.appendChild(select);
            listDiv.appendChild(div);
          });
        }
      }
      listDiv.classList.remove('hidden');
    });

    // ====== الباركود مع اختيار الكاميرا ======
    document.getElementById('barcodeBtn').addEventListener('click', async ()=>{
      const readerDiv = document.getElementById('barcodeReader');
      const statusDiv = document.getElementById('barcodeStatus');
      const barcodeBtn = document.getElementById('barcodeBtn');
      const stopBtn = document.getElementById('stopBarcodeBtn');
      
      readerDiv.classList.remove('hidden');
      statusDiv.classList.remove('hidden');
      statusDiv.innerHTML = 'جاري تشغيل الكاميرا...';
      barcodeBtn.style.display = 'none';
      stopBtn.style.display = 'inline-block';

      try {
        // استخدام getUserMedia مباشرة
        const stream = await navigator.mediaDevices.getUserMedia({ 
          video: { 
            facingMode: { ideal: 'environment' },
            width: { ideal: 640 },
            height: { ideal: 480 }
          } 
        });
        
        // إنشاء عنصر فيديو
        const video = document.createElement('video');
        video.srcObject = stream;
        video.autoplay = true;
        video.playsInline = true;
        video.style.width = '100%';
        video.style.height = 'auto';
        video.style.borderRadius = '8px';
        video.id = 'cameraVideo';
        
        readerDiv.innerHTML = '';
        readerDiv.appendChild(video);
        
        statusDiv.innerHTML = 'الماسح يعمل - وجه الباركود للكاميرا';
        
        // بدء قراءة الباركود
        startBarcodeScanning(video, stream);
        
      } catch (error) {
        console.error('خطأ في تشغيل الكاميرا:', error);
        statusDiv.innerHTML = `
          <div style="color: #dc3545;">
            ❌ تعذر تشغيل الكاميرا<br>
            <small>تأكد من:</small><br>
            • منح إذن الكاميرا<br>
            • إغلاق التطبيقات الأخرى<br>
            • استخدام HTTPS
          </div>
        `;
        barcodeBtn.style.display = 'inline-block';
        stopBtn.style.display = 'none';
      }
    });

    // زر إيقاف الماسح
    document.getElementById('stopBarcodeBtn').addEventListener('click', async ()=>{
      const readerDiv = document.getElementById('barcodeReader');
      const statusDiv = document.getElementById('barcodeStatus');
      const barcodeBtn = document.getElementById('barcodeBtn');
      const stopBtn = document.getElementById('stopBarcodeBtn');
      
      // إيقاف البث
      if(window.currentStream) {
        window.currentStream.getTracks().forEach(track => track.stop());
        window.currentStream = null;
      }
      
      // إيقاف المسح
      if(window.isScanning) {
        window.isScanning = false;
      }
      
      readerDiv.classList.add('hidden');
      statusDiv.classList.add('hidden');
      barcodeBtn.style.display = 'inline-block';
      stopBtn.style.display = 'none';
      statusDiv.innerHTML = '';
    });


    // دالة قراءة الباركود
    function startBarcodeScanning(video, stream) {
      window.currentStream = stream;
      window.isScanning = true;
      
      // إنشاء canvas لرسم الفيديو عليه
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      canvas.style.display = 'none';
      document.body.appendChild(canvas);
      
      function scanFrame() {
        if (!window.isScanning) return;
        
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        // استخدام jsQR لقراءة QR codes
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, imageData.width, imageData.height);
        
        if (code) {
          console.log('تم قراءة QR Code:', code.data);
          handleBarcodeScanned(code.data);
          window.isScanning = false;
          return;
        }
        
        // الاستمرار في المسح
        if (window.isScanning) {
          requestAnimationFrame(scanFrame);
        }
      }
      
      // بدء المسح
      video.addEventListener('loadedmetadata', () => {
        scanFrame();
      });
    }

    // دالة معالجة الباركود المقروء
    function handleBarcodeScanned(decodedText) {
      const statusDiv = document.getElementById('barcodeStatus');
      const listDiv = document.getElementById('studentsList');
      const items = listDiv.querySelectorAll('.student-item');
      
      console.log('البحث عن الباركود:', decodedText);
      
      // تنظيف النص
      const cleanBarcode = decodedText.toString().trim();
      
      for(let item of items){
        const studentName = item.getAttribute('data-name');
        const studentId = item.getAttribute('data-id');
        const allIds = JSON.parse(item.getAttribute('data-all-ids') || '[]');
        const qrContent = item.getAttribute('data-qr-content');
        
        // البحث في جميع الأرقام المحتملة
        const searchIds = [studentId, ...allIds].filter(Boolean);
        
        // إضافة محتوى QR code للبحث
        if (qrContent) {
          searchIds.push(qrContent);
        }
        
        for(let id of searchIds) {
          const cleanId = id.toString().trim();
          
          // مقارنة دقيقة
          if (cleanBarcode === cleanId || 
              cleanBarcode.includes(cleanId) || 
              cleanId.includes(cleanBarcode)) {
            
            const select = item.querySelector('select');
            select.value = 'حاضر';
            item.style.background = 'var(--present)';
            
            statusDiv.innerHTML = `<div style="color: #28a745; font-weight: bold; text-align: center;">${studentName}</div>`;
            
            item.style.transform = 'scale(1.05)';
            setTimeout(() => {
              item.style.transform = 'scale(1)';
            }, 300);
            
            // إعادة تشغيل المسح بعد ثانيتين
            setTimeout(() => {
              if (window.isScanning === false) {
                window.isScanning = true;
                const video = document.getElementById('cameraVideo');
                if (video && video.srcObject) {
                  startBarcodeScanning(video, video.srcObject);
                }
              }
            }, 2000);
            
            return;
          }
        }
      }
      
      statusDiv.innerHTML = `
        <div style="color: #dc3545;">
          ❌ لم يتم العثور على طالب: ${cleanBarcode}<br>
          <small>تأكد من رفع ملف Excel وعرض قائمة الطلاب</small>
        </div>
      `;
    }

    // ====== دوال التصدير ======
    
    // دالة تصدير Excel
    document.getElementById('exportExcelBtn').addEventListener('click', () => {
      const schoolName = document.getElementById('schoolName').value || 'غير محدد';
      const teacherName = document.getElementById('teacherName').value || 'غير محدد';
      const subjectName = document.getElementById('subjectName').value || 'غير محدد';
      const grade = document.getElementById('grade').value || 'غير محدد';
      const classroom = document.getElementById('classroom').value || 'غير محدد';
      const period = document.getElementById('period').value || 'غير محدد';
      
      const currentDate = new Date();
      const dateStr = currentDate.toLocaleDateString('ar-SA');
      const timeStr = currentDate.toLocaleTimeString('ar-SA');
      
      // جمع بيانات الحضور
      const attendanceData = [];
      const studentItems = document.querySelectorAll('.student-item');
      
      studentItems.forEach(item => {
        const name = item.getAttribute('data-name');
        const select = item.querySelector('select');
        const status = select.value || 'غير محدد';
        
        attendanceData.push({
          'اسم الطالب': name,
          'الحالة': status,
          'التاريخ': dateStr,
          'الوقت': timeStr
        });
      });
      
      if (attendanceData.length === 0) {
        alert('لا توجد بيانات حضور للتصدير. تأكد من عرض قائمة الطلاب أولاً.');
        return;
      }
      
      // إنشاء ملف Excel
      const wb = XLSX.utils.book_new();
      
      // إضافة معلومات التقرير
      const reportInfo = [
        ['اسم المدرسة', schoolName],
        ['اسم المعلم', teacherName],
        ['المادة', subjectName],
        ['الصف', grade],
        ['الفصل', classroom],
        ['رقم الحصة', period],
        ['التاريخ', dateStr],
        ['الوقت', timeStr],
        ['', ''],
        ['', '']
      ];
      
      const ws1 = XLSX.utils.aoa_to_sheet(reportInfo);
      XLSX.utils.book_append_sheet(wb, ws1, 'معلومات التقرير');
      
      // إضافة بيانات الحضور
      const ws2 = XLSX.utils.json_to_sheet(attendanceData);
      XLSX.utils.book_append_sheet(wb, ws2, 'بيانات الحضور');
      
      // حفظ الملف
      const fileName = `تقرير_حضور_${grade}_${classroom}_${dateStr.replace(/\//g, '-')}.xlsx`;
      XLSX.writeFile(wb, fileName);
    });
    
    // دالة تصدير PDF
    document.getElementById('exportPdfBtn').addEventListener('click', () => {
      const schoolName = document.getElementById('schoolName').value || 'غير محدد';
      const teacherName = document.getElementById('teacherName').value || 'غير محدد';
      const subjectName = document.getElementById('subjectName').value || 'غير محدد';
      const grade = document.getElementById('grade').value || 'غير محدد';
      const classroom = document.getElementById('classroom').value || 'غير محدد';
      const period = document.getElementById('period').value || 'غير محدد';
      
      const currentDate = new Date();
      const dateStr = currentDate.toLocaleDateString('ar-SA');
      const timeStr = currentDate.toLocaleTimeString('ar-SA');
      
      // جمع بيانات الحضور
      const attendanceData = [];
      const studentItems = document.querySelectorAll('.student-item');
      
      studentItems.forEach(item => {
        const name = item.getAttribute('data-name');
        const select = item.querySelector('select');
        const status = select.value || 'غير محدد';
        
        attendanceData.push({
          name: name,
          status: status
        });
      });
      
      if (attendanceData.length === 0) {
        alert('لا توجد بيانات حضور للتصدير. تأكد من عرض قائمة الطلاب أولاً.');
        return;
      }
      
      // إنشاء PDF
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // إعداد الخط العربي
      doc.setFont('helvetica');
      
      // العنوان الرئيسي
      doc.setFontSize(18);
      doc.setFont('helvetica', 'bold');
      doc.text('تقرير حضور الطلاب', 105, 20, { align: 'center' });
      
      // خط فاصل
      doc.line(20, 25, 190, 25);
      
      // معلومات التقرير
      doc.setFontSize(12);
      doc.setFont('helvetica', 'normal');
      
      let yPos = 35;
      const lineHeight = 7;
      
      doc.text(`اسم المدرسة: ${schoolName}`, 20, yPos);
      yPos += lineHeight;
      doc.text(`اسم المعلم: ${teacherName}`, 20, yPos);
      yPos += lineHeight;
      doc.text(`المادة: ${subjectName}`, 20, yPos);
      yPos += lineHeight;
      doc.text(`الصف: ${grade}`, 20, yPos);
      yPos += lineHeight;
      doc.text(`الفصل: ${classroom}`, 20, yPos);
      yPos += lineHeight;
      doc.text(`رقم الحصة: ${period}`, 20, yPos);
      yPos += lineHeight;
      doc.text(`التاريخ: ${dateStr}`, 20, yPos);
      yPos += lineHeight;
      doc.text(`الوقت: ${timeStr}`, 20, yPos);
      
      yPos += 15;
      
      // جدول الحضور
      doc.setFontSize(14);
      doc.setFont('helvetica', 'bold');
      doc.text('بيانات الحضور', 105, yPos, { align: 'center' });
      yPos += 10;
      
      // رؤوس الجدول
      doc.setFontSize(10);
      doc.setFont('helvetica', 'bold');
      doc.text('م', 25, yPos);
      doc.text('اسم الطالب', 40, yPos);
      doc.text('الحالة', 120, yPos);
      doc.text('التوقيع', 160, yPos);
      
      yPos += 5;
      doc.line(20, yPos, 190, yPos);
      yPos += 8;
      
      // بيانات الطلاب
      doc.setFont('helvetica', 'normal');
      attendanceData.forEach((student, index) => {
        if (yPos > 250) {
          doc.addPage();
          yPos = 20;
        }
        
        doc.text((index + 1).toString(), 25, yPos);
        doc.text(student.name, 40, yPos);
        doc.text(student.status, 120, yPos);
        doc.line(160, yPos - 3, 190, yPos - 3);
        
        yPos += 8;
      });
      
      // إحصائيات
      yPos += 10;
      doc.setFont('helvetica', 'bold');
      doc.text('إحصائيات الحضور:', 20, yPos);
      yPos += 8;
      
      const present = attendanceData.filter(s => s.status === 'حاضر').length;
      const absent = attendanceData.filter(s => s.status === 'غائب').length;
      const late = attendanceData.filter(s => s.status === 'متأخر').length;
      const total = attendanceData.length;
      
      doc.setFont('helvetica', 'normal');
      doc.text(`إجمالي الطلاب: ${total}`, 20, yPos);
      yPos += 6;
      doc.text(`الحضور: ${present}`, 20, yPos);
      yPos += 6;
      doc.text(`الغياب: ${absent}`, 20, yPos);
      yPos += 6;
      doc.text(`التأخير: ${late}`, 20, yPos);
      yPos += 6;
      doc.text(`نسبة الحضور: ${((present / total) * 100).toFixed(1)}%`, 20, yPos);
      
      // حفظ الملف
      const fileName = `تقرير_حضور_${grade}_${classroom}_${dateStr.replace(/\//g, '-')}.pdf`;
      doc.save(fileName);
    });

  </script>
</body>
</html>